{% extends "base.html" %}
{% block title %}{{ block.super }} - Filtro{% endblock %}
{% block extra_head %}
    <style type="text/css">
        select { width: 300px }
    </style>
{% endblock %}
{% block script %}
<script type="text/javascript">
$(function(){

    // Variaveis
    var $id_estado = $("#id_estado");
    var $id_cidade = $("#id_cidade");
    var $id_bairro = $("#id_bairro");

    function carrega_cidades(){
        var $val_estado = $id_estado.val();

        if ($val_estado > 0){
            $.get("/address/estado/" + $val_estado, function(data){

                // Abilitando o select
                $id_cidade.select2("enable");

                $id_cidade.find("option").remove();

                // Preenchendo
                $.each(data.cidades, function(i, item) {
                    $id_cidade.append(
                            "<option id='"+data.cidades[i].pk+"' value='"+data.cidades[i].pk+"'>"+
                                    data.cidades[i].nome
                                    +"</option>"
                    );
                });

                // Carrega cidades e indica visualmente
                $id_cidade.prepend("<option value='0' selected='selected'>-- Selecione --</option>");
                $id_cidade.select2("val", 0);

                // Limpa bairros e indica visualmente
                $id_bairro.html("<option value='0' selected='selected'>-- Vazio --</option>");
                $id_bairro.select2("val", 0);
            });
        }
    }

    function carrega_bairros(){
        var $val_cidade = $id_cidade.val();

        if ($val_cidade > 0){
            $.get("/address/cidade/" + $val_cidade, function(data){

                // Abilitando o select
                $id_bairro.select2("enable");

                $id_bairro.find("option").remove();

                // Preenchendo
                $.each(data.bairros, function(i, item) {
                    $id_bairro.append(
                            "<option id='"+data.bairros[i].pk+"' value='"+data.bairros[i].pk+"'>"+
                                    data.bairros[i].nome
                                    +"</option>"
                    );
                });
                $id_bairro.prepend("<option value='0' selected='selected'>-- Selecione --</option>");
                $id_bairro.select2("val", 0);
            });
        }
    }

    $id_estado.select2();
    $id_cidade.select2();
    $id_bairro.select2();

    // Change
    $id_estado.bind("change", carrega_cidades);
    $id_cidade.bind("change", carrega_bairros);

    {% if not request.session.endereco %}
        $id_estado.select2("val", 0);

        $id_cidade.select2("val", 0);
        $id_cidade.select2("disable");

        $id_bairro.select2("val", 0);
        $id_bairro.select2("disable");
    {% endif %}

});
</script>
{% endblock %}
{% block content %}
<form id="form_local" action="{% url address:confirmar-endereco-select2 %}" method="post">{% csrf_token %}
    {% for field in form %}
        <p>{{ field }}</p>
    {% endfor %}
    <p><button type="submit">Confirmar</button> |
    <a href="{% url address:remover-endereco-select2 %}">Remover</a></p>
</form>
<div class="update">
{% if request.session.endereco %}
<h3>Por estabelecimentos</h3>
<ul>
    {% for estabelecimento in estabelecimentos %}
    <li>
        Nome: <strong>{{ estabelecimento.nome }}</strong><br />
        Bairro: {{ estabelecimento.bairro.nome }}<br />
        Cidade: {{ estabelecimento.cidade.nome }}<br />
        Estado: {{ estabelecimento.estado.sigla }}
        <hr />
    </li>
    {% endfor %}
</ul>
{% endif %}
</div>
{% endblock %}